# JWT Token Validation Issue - Debugging Guide

## Current Status
- **Frontend**: Deployed at https://jala2-dev.netlify.app/
- **Backend**: Deployed to `wjfcqqrlhwdvvjmefxky.supabase.co`
- **Error**: "Invalid JWT" (401) after login

## JWT Token Flow

### 1. Login Process (Token Generation)
```
User Login
    ↓
Frontend: POST /auth/login
    ↓
Backend: supabase.auth.signInWithPassword()
    ↓
Supabase Auth (at PROJECT_X) generates JWT
    ↓
Backend returns: { access_token: "eyJ..." }
    ↓
Frontend stores token in sessionStorage
```

### 2. Authenticated Request (Token Validation)
```
Frontend: GET /clients (with Bearer token)
    ↓
Backend: requireAuth middleware
    ↓
Backend: supabase.auth.getUser(token)
    ↓
Supabase Auth (at PROJECT_Y) validates JWT
    ↓
✅ SUCCESS if PROJECT_X === PROJECT_Y
❌ FAIL if PROJECT_X !== PROJECT_Y
```

## Root Cause Analysis

The JWT token must be **generated** and **validated** by the **same** Supabase project.

### Possible Issues:

#### Issue 1: Frontend Logging Into Wrong Project
**Symptoms**: Token is generated by a different Supabase project than where backend is deployed

**Check**:
```bash
# Frontend environment configuration
cat /src/app/config/deploymentEnvironments.ts | grep DEV_PROJECT_ID
# Should show: wjfcqqrlhwdvvjmefxky

# Frontend is using this for login
cat /utils/supabase/info.tsx
# Should show: wjfcqqrlhwdvvjmefxky
```

**Fix**: Update frontend config to use correct project ID

---

#### Issue 2: Backend Using Wrong Supabase Client
**Symptoms**: Backend validates tokens against a different project than it logs into

**Check**:
```bash
# Test backend health endpoint
curl https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/health

# Response should show:
{
  "deployment": {
    "supabaseUrl": "https://wjfcqqrlhwdvvjmefxky.supabase.co",
    "supabaseProject": "wjfcqqrlhwdvvjmefxky"
  }
}
```

**Fix**: Supabase automatically sets `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` to match the project. If these are wrong, the deployment itself is wrong.

---

#### Issue 3: Mixed Environment IDs
**Symptoms**: Frontend sends `X-Environment-ID: production` but backend expects `development`

**Check browser console**:
```javascript
// In browser console at https://jala2-dev.netlify.app/admin/login
localStorage.getItem('jala_environment')
// Should be: null (defaults to 'production') or 'development'
```

**Fix**: 
```javascript
// In browser console
localStorage.setItem('jala_environment', 'development')
// Then refresh and try login again
```

---

#### Issue 4: Token Issued by One Supabase Project, Validated by Another
**Symptoms**: This is the actual root cause - cross-project JWT validation fails

**Theory**:
1. Frontend logs in → Backend calls `supabaseA.auth.signInWithPassword()`
2. Supabase Auth at Project A generates JWT signed with Project A's secret
3. Frontend makes request → Backend calls `supabaseB.auth.getUser(token)`
4. Supabase Auth at Project B tries to validate JWT with Project B's secret
5. ❌ Validation fails → "Invalid JWT"

**Diagnosis**:
```bash
# Get a JWT token by logging in
curl -X POST https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/auth/login \
  -H "Content-Type: application/json" \
  -d '{"identifier": "admin@jala2.com", "password": "YourPassword"}'

# Copy the access_token and decode it at https://jwt.io
# Look at the "iss" (issuer) claim - it should be:
# "iss": "https://wjfcqqrlhwdvvjmefxky.supabase.co/auth/v1"
```

---

## Step-by-Step Debugging

### Step 1: Verify Backend Configuration
```bash
curl https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/health
```

Expected output:
```json
{
  "status": "ok",
  "deployment": {
    "supabaseProject": "wjfcqqrlhwdvvjmefxky",
    "supabaseUrl": "https://wjfcqqrlhwdvvjmefxky.supabase.co",
    "hasServiceRoleKey": true,
    "environmentRequested": "development"
  }
}
```

### Step 2: Test Login (Token Generation)
```bash
curl -X POST https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Environment-ID: development" \
  -d '{
    "identifier": "admin@jala2.com",
    "password": "YourPassword123!"
  }'
```

Expected output:
```json
{
  "access_token": "eyJhbGc...",
  "user": { ... }
}
```

### Step 3: Decode JWT Token
1. Copy the `access_token` from Step 2
2. Go to https://jwt.io
3. Paste the token
4. Check the payload:
   - `iss` should be `https://wjfcqqrlhwdvvjmefxky.supabase.co/auth/v1`
   - `sub` is the user ID
   - `exp` is the expiration time

### Step 4: Test Token Validation
```bash
# Use the token from Step 2
curl https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/clients \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN_HERE" \
  -H "X-Environment-ID: development"
```

Expected output:
- ✅ Status 200 with list of clients (or empty array)
- ❌ Status 401 with "Invalid JWT" → Token validation failed

### Step 5: Check Backend Logs
```bash
# Go to Supabase dashboard
open https://supabase.com/dashboard/project/wjfcqqrlhwdvvjmefxky/logs/edge-functions

# Filter for "JWT" or "Verification"
# Look for error messages like:
# "JWT Verification Error: Invalid JWT"
# "Supabase URL being used: ..."
```

---

## Solutions

### Solution A: Ensure Consistent Environment
The most common fix is to make sure both frontend and backend use the same environment:

1. **In browser console** (at https://jala2-dev.netlify.app):
   ```javascript
   localStorage.setItem('jala_environment', 'development')
   location.reload()
   ```

2. **Try login again**

### Solution B: Check Admin User Exists in Correct Project
The admin user must exist in the Supabase Auth database of `wjfcqqrlhwdvvjmefxky`:

1. Go to: https://supabase.com/dashboard/project/wjfcqqrlhwdvvjmefxky/auth/users
2. Verify user `admin@jala2.com` exists
3. If not, create it or use the Bootstrap page

### Solution C: Re-create Admin User
If the admin user was created in the wrong Supabase project:

1. Delete the user from the wrong project
2. Go to https://jala2-dev.netlify.app/admin/bootstrap
3. Create a new admin user
4. This will create the user in the correct project

### Solution D: Check for Typos in Project ID
We previously had an issue with `wjfcqqrlhwdvjmefxky` vs `wjfcqqrlhwdvvjmefxky` (single 'v' vs double 'v').

The **CORRECT** project ID is: `wjfcqqrlhwdvvjmefxky` (with **double 'v'**)

Verify all files use the correct ID:
```bash
cd ~/jala2-app
grep -r "wjfcqqrlhwdv" --include="*.ts" --include="*.tsx" src/ utils/ scripts/
# All should show: wjfcqqrlhwdvvjmefxky (with double 'v')
```

---

## Quick Test Commands

```bash
# 1. Health check
curl https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/health

# 2. Login
curl -X POST https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Environment-ID: development" \
  -d '{"identifier":"admin@jala2.com","password":"YourPassword123!"}'

# 3. Test authenticated endpoint
curl https://wjfcqqrlhwdvvjmefxky.supabase.co/functions/v1/make-server-6fcaeea3/clients \
  -H "Authorization: Bearer TOKEN_FROM_STEP_2" \
  -H "X-Environment-ID: development"
```

---

## Next Steps

1. **Redeploy backend** with updated health endpoint:
   ```bash
   cd ~/jala2-app
   ./scripts/redeploy-backend.sh dev
   ```

2. **Check health endpoint** to see actual Supabase URL

3. **Test login flow** and check JWT issuer

4. **Report findings** so we can identify the exact mismatch

---

**Last Updated**: February 8, 2026
