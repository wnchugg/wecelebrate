{"version":3,"file":"networkUtils.js","sources":["../../src/networkUtils.ts"],"sourcesContent":["import { debug } from '@sentry/core';\nimport { DEBUG_BUILD } from './debug-build';\nimport type { NetworkMetaWarning } from './types';\n\n// Symbol used by e.g. the Replay integration to store original body on Request objects\nexport const ORIGINAL_REQ_BODY = Symbol.for('sentry__originalRequestBody');\n\n/**\n * Serializes FormData.\n *\n * This is a bit simplified, but gives us a decent estimate.\n * This converts e.g. { name: 'Anne Smith', age: 13 } to 'name=Anne+Smith&age=13'.\n *\n */\nexport function serializeFormData(formData: FormData): string {\n  // @ts-expect-error passing FormData to URLSearchParams actually works\n  return new URLSearchParams(formData).toString();\n}\n\n/** Get the string representation of a body. */\nexport function getBodyString(body: unknown, _debug: typeof debug = debug): [string | undefined, NetworkMetaWarning?] {\n  try {\n    if (typeof body === 'string') {\n      return [body];\n    }\n\n    if (body instanceof URLSearchParams) {\n      return [body.toString()];\n    }\n\n    if (body instanceof FormData) {\n      return [serializeFormData(body)];\n    }\n\n    if (!body) {\n      return [undefined];\n    }\n  } catch (error) {\n    DEBUG_BUILD && _debug.error(error, 'Failed to serialize body', body);\n    return [undefined, 'BODY_PARSE_ERROR'];\n  }\n\n  DEBUG_BUILD && _debug.log('Skipping network body because of body type', body);\n\n  return [undefined, 'UNPARSEABLE_BODY_TYPE'];\n}\n\n/**\n * Parses the fetch arguments to extract the request payload.\n *\n * In case of a Request object, this function attempts to retrieve the original body by looking for a Sentry-patched symbol.\n */\nexport function getFetchRequestArgBody(fetchArgs: unknown[] = []): RequestInit['body'] | undefined {\n  // Second argument with body options takes precedence\n  if (fetchArgs.length >= 2 && fetchArgs[1] && typeof fetchArgs[1] === 'object' && 'body' in fetchArgs[1]) {\n    return (fetchArgs[1] as RequestInit).body;\n  }\n\n  if (fetchArgs.length >= 1 && fetchArgs[0] instanceof Request) {\n    const request = fetchArgs[0];\n    /* The Request interface's body is a ReadableStream, which we cannot directly access.\n       Some integrations (e.g. Replay) patch the Request object to store the original body. */\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-member-access\n    const originalBody = (request as any)[ORIGINAL_REQ_BODY];\n    if (originalBody !== undefined) {\n      return originalBody;\n    }\n\n    return undefined; // Fall back to returning undefined (as we don't want to return a ReadableStream)\n  }\n\n  return undefined;\n}\n\n/**\n * Parses XMLHttpRequest response headers into a Record.\n * Extracted from replay internals to be reusable.\n */\nexport function parseXhrResponseHeaders(xhr: XMLHttpRequest): Record<string, string> {\n  let headers: string | undefined;\n  try {\n    headers = xhr.getAllResponseHeaders();\n  } catch (error) {\n    DEBUG_BUILD && debug.error(error, 'Failed to get xhr response headers', xhr);\n    return {};\n  }\n\n  if (!headers) {\n    return {};\n  }\n\n  return headers.split('\\r\\n').reduce((acc: Record<string, string>, line: string) => {\n    const [key, value] = line.split(': ') as [string, string | undefined];\n    if (value) {\n      acc[key.toLowerCase()] = value;\n    }\n    return acc;\n  }, {});\n}\n"],"names":["debug","DEBUG_BUILD"],"mappings":"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"}