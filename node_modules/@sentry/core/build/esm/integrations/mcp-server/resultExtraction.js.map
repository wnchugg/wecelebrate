{"version":3,"file":"resultExtraction.js","sources":["../../../../src/integrations/mcp-server/resultExtraction.ts"],"sourcesContent":["/**\n * Result extraction functions for MCP server instrumentation\n *\n * Handles extraction of attributes from tool and prompt execution results.\n */\n\nimport {\n  MCP_PROMPT_RESULT_DESCRIPTION_ATTRIBUTE,\n  MCP_PROMPT_RESULT_MESSAGE_COUNT_ATTRIBUTE,\n  MCP_TOOL_RESULT_CONTENT_COUNT_ATTRIBUTE,\n  MCP_TOOL_RESULT_IS_ERROR_ATTRIBUTE,\n} from './attributes';\nimport { isValidContentItem } from './validation';\n\n/**\n * Build attributes for tool result content items\n * @param content - Array of content items from tool result\n * @param includeContent - Whether to include actual content (text, URIs) or just metadata\n * @returns Attributes extracted from each content item\n */\nfunction buildAllContentItemAttributes(\n  content: unknown[],\n  includeContent: boolean,\n): Record<string, string | number | boolean> {\n  const attributes: Record<string, string | number> = {\n    [MCP_TOOL_RESULT_CONTENT_COUNT_ATTRIBUTE]: content.length,\n  };\n\n  for (const [i, item] of content.entries()) {\n    if (!isValidContentItem(item)) {\n      continue;\n    }\n\n    const prefix = content.length === 1 ? 'mcp.tool.result' : `mcp.tool.result.${i}`;\n\n    if (typeof item.type === 'string') {\n      attributes[`${prefix}.content_type`] = item.type;\n    }\n\n    if (includeContent) {\n      const safeSet = (key: string, value: unknown): void => {\n        if (typeof value === 'string') {\n          attributes[`${prefix}.${key}`] = value;\n        }\n      };\n\n      safeSet('mime_type', item.mimeType);\n      safeSet('uri', item.uri);\n      safeSet('name', item.name);\n\n      if (typeof item.text === 'string') {\n        attributes[`${prefix}.content`] = item.text;\n      }\n\n      if (typeof item.data === 'string') {\n        attributes[`${prefix}.data_size`] = item.data.length;\n      }\n\n      const resource = item.resource;\n      if (isValidContentItem(resource)) {\n        safeSet('resource_uri', resource.uri);\n        safeSet('resource_mime_type', resource.mimeType);\n      }\n    }\n  }\n\n  return attributes;\n}\n\n/**\n * Extract tool result attributes for span instrumentation\n * @param result - Tool execution result\n * @param recordOutputs - Whether to include actual content or just metadata (counts, error status)\n * @returns Attributes extracted from tool result content\n */\nexport function extractToolResultAttributes(\n  result: unknown,\n  recordOutputs: boolean,\n): Record<string, string | number | boolean> {\n  if (!isValidContentItem(result)) {\n    return {};\n  }\n\n  const attributes = Array.isArray(result.content) ? buildAllContentItemAttributes(result.content, recordOutputs) : {};\n\n  if (typeof result.isError === 'boolean') {\n    attributes[MCP_TOOL_RESULT_IS_ERROR_ATTRIBUTE] = result.isError;\n  }\n\n  return attributes;\n}\n\n/**\n * Extract prompt result attributes for span instrumentation\n * @param result - Prompt execution result\n * @param recordOutputs - Whether to include actual content or just metadata (counts)\n * @returns Attributes extracted from prompt result\n */\nexport function extractPromptResultAttributes(\n  result: unknown,\n  recordOutputs: boolean,\n): Record<string, string | number | boolean> {\n  const attributes: Record<string, string | number | boolean> = {};\n  if (!isValidContentItem(result)) {\n    return attributes;\n  }\n\n  if (recordOutputs && typeof result.description === 'string') {\n    attributes[MCP_PROMPT_RESULT_DESCRIPTION_ATTRIBUTE] = result.description;\n  }\n\n  if (Array.isArray(result.messages)) {\n    attributes[MCP_PROMPT_RESULT_MESSAGE_COUNT_ATTRIBUTE] = result.messages.length;\n\n    if (recordOutputs) {\n      const messages = result.messages;\n      for (const [i, message] of messages.entries()) {\n        if (!isValidContentItem(message)) {\n          continue;\n        }\n\n        const prefix = messages.length === 1 ? 'mcp.prompt.result' : `mcp.prompt.result.${i}`;\n\n        const safeSet = (key: string, value: unknown): void => {\n          if (typeof value === 'string') {\n            const attrName = messages.length === 1 ? `${prefix}.message_${key}` : `${prefix}.${key}`;\n            attributes[attrName] = value;\n          }\n        };\n\n        safeSet('role', message.role);\n\n        if (isValidContentItem(message.content)) {\n          const content = message.content;\n          if (typeof content.text === 'string') {\n            const attrName = messages.length === 1 ? `${prefix}.message_content` : `${prefix}.content`;\n            attributes[attrName] = content.text;\n          }\n        }\n      }\n    }\n  }\n\n  return attributes;\n}\n"],"names":[],"mappings":"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"}