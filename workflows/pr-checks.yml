name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel outdated runs
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: PR Validation
  validate:
    name: ğŸ” Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ·ï¸ Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            
      - name: ğŸ“ Check PR description
        run: |
          if [ -z "${{ github.event.pull_request.body }}" ]; then
            echo "âŒ PR description is empty"
            exit 1
          fi
          echo "âœ… PR has description"
          
      - name: ğŸ·ï¸ Check for labels
        run: |
          LABELS=$(echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | jq -r '.[]')
          if [ -z "$LABELS" ]; then
            echo "âš ï¸ No labels found on PR"
          else
            echo "âœ… PR has labels: $LABELS"
          fi
          
  # Job 2: Code Quality Check
  quality:
    name: ğŸ¯ Code Quality
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ” Run ESLint
        run: npm run lint
        
      - name: ğŸ’… Check Prettier
        run: npm run format:check
        
      - name: ğŸ“˜ TypeScript check
        run: npm run typecheck
        
  # Job 3: Test Changes
  test-changes:
    name: ğŸ§ª Test Changed Files
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run tests for changed files
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No TypeScript files changed"
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            npm run test:related -- $CHANGED_FILES
          fi
        env:
          CI: true
          
  # Job 4: Coverage Check
  coverage:
    name: ğŸ“Š Coverage Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run tests with coverage
        run: npm run test:coverage
        env:
          CI: true
          
      - name: ğŸ“Š Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Current coverage: $COVERAGE%"
          
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "âŒ Coverage is below 90% threshold"
            exit 1
          fi
          
          echo "âœ… Coverage meets 90% threshold"
          
      - name: ğŸ’¬ Comment coverage on PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
  # Job 5: Size Check
  size-check:
    name: ğŸ“¦ Bundle Size Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: ğŸ“Š Analyze bundle size
        run: |
          BUNDLE_SIZE=$(du -sh dist | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE"
          echo "BUNDLE_SIZE=$BUNDLE_SIZE" >> $GITHUB_ENV
          
      - name: ğŸ’¬ Comment bundle size
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“¦ **Bundle Size:** ${process.env.BUNDLE_SIZE}\n\nâœ… Build completed successfully!`
            })
            
  # Job 6: Security Check
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true
        
      - name: ğŸ”’ Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          
  # Job 7: Auto-assign reviewers
  auto-assign:
    name: ğŸ‘¥ Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ‘¥ Auto-assign reviewers
        uses: kentaro-m/auto-assign-action@v1.2.5
        with:
          configuration-path: '.github/auto-assign.yml'
          
  # Job 8: PR Status Summary
  pr-summary:
    name: ğŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [validate, quality, test-changes, coverage, size-check, security]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“‹ Generate PR summary
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJson(needs) }};
            const results = Object.entries(needs).map(([job, result]) => {
              const icon = result.result === 'success' ? 'âœ…' : 'âŒ';
              return `${icon} ${job}: ${result.result}`;
            }).join('\n');
            
            const allPassed = Object.values(needs).every(job => job.result === 'success');
            const emoji = allPassed ? 'ğŸ‰' : 'âš ï¸';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} **PR Checks Summary**\n\n${results}\n\n${allPassed ? 'âœ… All checks passed! Ready for review.' : 'âŒ Some checks failed. Please fix the issues.'}`
            })
