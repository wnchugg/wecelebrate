import{s}from"./supabase-CKmDi08e.js";import{h as a,l as p,a as d}from"./AccessManagement-BOIvlDsH.js";import"./index-BO2tctDo.js";import"./index-dV4Uttrq.js";import"./index-DS1l-0-y.js";import"./index-Bnc4558u.js";import"./exceljs.min-YwBJtYY3.js";import"./fileSecurityHelpers-CSk_xi4i.js";import"./dialog-BOcbCdZI.js";import"./index-Ttf8ZMtO.js";import"./index-C8MzEdCL.js";import"./index-DJFIPDZ_.js";import"./index-faiGe14u.js";import"./badge-hStN7-Ju.js";import"./tabs-DGJXxrgD.js";import"./index-DYppfwNE.js";import"./index-DS-6jgr9.js";import"./alert-DuWbj2LH.js";import"./users-DibFapgP.js";import"./upload-BBB967fQ.js";import"./download-CZmMXIZR.js";import"./file-spreadsheet-CMZQL9uR.js";import"./circle-check-big-BTbhA0uw.js";import"./circle-x-CrdKUO8e.js";import"./circle-alert-DNo9lQw-.js";import"./file-text-DnvqV_SC.js";import"./loader-circle-BpaB5MSO.js";import"./square-pen-BiMIh-Tu.js";import"./key-DTxr6Nxn.js";import"./eye-off-DmeI3nVv.js";import"./eye-CnbqyKZE.js";import"./plus-DUZUgypq.js";import"./mail-HBGoXm34.js";import"./trash-2-B2VV2ZDP.js";import"./id-card-BpLNM96h.js";import"./credit-card-UgC4ysmM.js";async function U(i){if(!await a("proxy_login"))throw new Error("Insufficient permissions: proxy_login permission required");const t=i.durationMinutes||30,r=new Date(Date.now()+t*60*1e3),{data:o,error:n}=await s.from("proxy_sessions").insert({admin_id:i.adminId,employee_id:i.employeeId,site_id:i.siteId,expires_at:r.toISOString(),is_active:!0}).select().single();if(n)throw console.error("Failed to create proxy session:",n),new Error("Failed to create proxy session");return await p(i.adminId,i.employeeId,i.siteId,o.id),{id:o.id,adminId:o.admin_id,employeeId:o.employee_id,siteId:o.site_id,token:o.token,expiresAt:new Date(o.expires_at),createdAt:new Date(o.created_at)}}async function m(i){const{data:e,error:t}=await s.from("proxy_sessions").select("*").eq("token",i).eq("is_active",!0).gt("expires_at",new Date().toISOString()).single();return t||!e?null:{id:e.id,adminId:e.admin_id,employeeId:e.employee_id,siteId:e.site_id,token:e.token,expiresAt:new Date(e.expires_at),createdAt:new Date(e.created_at)}}async function V(i){const{data:e}=await s.from("proxy_sessions").select("admin_id, employee_id, site_id, created_at").eq("id",i).single(),{error:t}=await s.from("proxy_sessions").update({is_active:!1}).eq("id",i);if(t)throw console.error("Failed to end proxy session:",t),new Error("Failed to end proxy session");if(e){const r=Math.floor((Date.now()-new Date(e.created_at).getTime())/1e3);await d(e.admin_id,e.employee_id,e.site_id,i,r)}}async function W(){const i=localStorage.getItem("proxy_session_token");return i?m(i):null}async function X(i){const{data:e,error:t}=await s.from("proxy_sessions").select("id, expires_at, is_active").eq("id",i).single();if(t||!e)return!1;const r=new Date(e.expires_at)<new Date;return e.is_active&&!r}export{U as createProxySession,V as endProxySession,W as getCurrentProxySession,m as getProxySession,X as validateProxySession};
