name: Code Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Generate Coverage Report
  coverage:
    name: ðŸ“Š Generate Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run all tests with coverage
        run: npm run test:coverage
        env:
          CI: true
          
      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info,./coverage/coverage-final.json
          flags: all-tests
          name: wecelebrate-coverage
          fail_ci_if_error: true
          verbose: true
          
      - name: ðŸ“Š Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./coverage/lcov.info
          
      - name: ðŸ’¾ Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/
            !coverage/**/*.map
          retention-days: 30
          
      - name: ðŸ“Š Generate coverage summary
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.json | jq -r '
            "| Metric | Coverage |",
            "|--------|----------|",
            "| Lines | \(.total.lines.pct)% |",
            "| Statements | \(.total.statements.pct)% |",
            "| Functions | \(.total.functions.pct)% |",
            "| Branches | \(.total.branches.pct)% |"
          ' >> $GITHUB_STEP_SUMMARY
          
  # Job 2: Coverage Comparison
  coverage-diff:
    name: ðŸ“ˆ Coverage Diff
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout PR code
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run tests with coverage
        run: npm run test:coverage
        env:
          CI: true
          
      - name: ðŸ’¾ Save PR coverage
        run: |
          mkdir -p /tmp/coverage
          cp coverage/coverage-summary.json /tmp/coverage/pr-coverage.json
          
      - name: ðŸ“¥ Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          
      - name: ðŸ“¦ Install dependencies (base)
        run: npm ci
        
      - name: ðŸ§ª Run tests with coverage (base)
        run: npm run test:coverage
        env:
          CI: true
          
      - name: ðŸ’¾ Save base coverage
        run: |
          cp coverage/coverage-summary.json /tmp/coverage/base-coverage.json
          
      - name: ðŸ“Š Compare coverage
        run: |
          PR_COV=$(cat /tmp/coverage/pr-coverage.json | jq '.total.lines.pct')
          BASE_COV=$(cat /tmp/coverage/base-coverage.json | jq '.total.lines.pct')
          DIFF=$(echo "$PR_COV - $BASE_COV" | bc)
          
          echo "Base coverage: $BASE_COV%"
          echo "PR coverage: $PR_COV%"
          echo "Difference: $DIFF%"
          
          if (( $(echo "$DIFF < 0" | bc -l) )); then
            echo "âš ï¸ Coverage decreased by $DIFF%"
            echo "COVERAGE_STATUS=âš ï¸ Decreased" >> $GITHUB_ENV
          elif (( $(echo "$DIFF > 0" | bc -l) )); then
            echo "âœ… Coverage increased by $DIFF%"
            echo "COVERAGE_STATUS=âœ… Increased" >> $GITHUB_ENV
          else
            echo "âž¡ï¸ Coverage unchanged"
            echo "COVERAGE_STATUS=âž¡ï¸ Unchanged" >> $GITHUB_ENV
          fi
          
          echo "PR_COVERAGE=$PR_COV" >> $GITHUB_ENV
          echo "BASE_COVERAGE=$BASE_COV" >> $GITHUB_ENV
          echo "COVERAGE_DIFF=$DIFF" >> $GITHUB_ENV
          
      - name: ðŸ’¬ Comment coverage diff on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prCov = parseFloat(process.env.PR_COVERAGE);
            const baseCov = parseFloat(process.env.BASE_COVERAGE);
            const diff = parseFloat(process.env.COVERAGE_DIFF);
            const status = process.env.COVERAGE_STATUS;
            
            const body = `## ðŸ“Š Coverage Report
            
            | Metric | Base | PR | Diff |
            |--------|------|-----|------|
            | Coverage | ${baseCov.toFixed(2)}% | ${prCov.toFixed(2)}% | ${diff >= 0 ? '+' : ''}${diff.toFixed(2)}% |
            
            **Status:** ${status}
            
            ${diff < -1 ? 'âš ï¸ **Warning:** Coverage decreased by more than 1%!' : ''}
            ${prCov < 90 ? 'âŒ **Error:** Coverage is below 90% threshold!' : 'âœ… Coverage meets 90% threshold'}
            
            <details>
            <summary>View detailed coverage report</summary>
            
            Check the [full coverage report](https://app.codecov.io/gh/${{ github.repository }}/pull/${{ github.event.pull_request.number }}) on Codecov.
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
  # Job 3: Enforce Coverage Threshold
  coverage-threshold:
    name: ðŸŽ¯ Enforce Threshold
    runs-on: ubuntu-latest
    needs: coverage
    
    steps:
      - name: ðŸ“¥ Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          
      - name: ðŸŽ¯ Check coverage thresholds
        run: |
          LINES=$(cat coverage-summary.json | jq '.total.lines.pct')
          STATEMENTS=$(cat coverage-summary.json | jq '.total.statements.pct')
          FUNCTIONS=$(cat coverage-summary.json | jq '.total.functions.pct')
          BRANCHES=$(cat coverage-summary.json | jq '.total.branches.pct')
          
          echo "Lines: $LINES%"
          echo "Statements: $STATEMENTS%"
          echo "Functions: $FUNCTIONS%"
          echo "Branches: $BRANCHES%"
          
          THRESHOLD=90
          FAILED=0
          
          if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
            echo "âŒ Lines coverage ($LINES%) is below $THRESHOLD%"
            FAILED=1
          fi
          
          if (( $(echo "$STATEMENTS < $THRESHOLD" | bc -l) )); then
            echo "âŒ Statements coverage ($STATEMENTS%) is below $THRESHOLD%"
            FAILED=1
          fi
          
          if (( $(echo "$FUNCTIONS < $THRESHOLD" | bc -l) )); then
            echo "âŒ Functions coverage ($FUNCTIONS%) is below $THRESHOLD%"
            FAILED=1
          fi
          
          if (( $(echo "$BRANCHES < $THRESHOLD" | bc -l) )); then
            echo "âŒ Branches coverage ($BRANCHES%) is below $THRESHOLD%"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo "Coverage check failed!"
            exit 1
          fi
          
          echo "âœ… All coverage thresholds met!"
          
  # Job 4: Upload to Multiple Services
  coverage-upload:
    name: ðŸ“¤ Upload to Services
    runs-on: ubuntu-latest
    needs: coverage
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          
      - name: ðŸ“Š Upload to Code Climate
        uses: paambaati/codeclimate-action@v5
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        with:
          coverageLocations: |
            ${{github.workspace}}/lcov.info:lcov
            
      - name: ðŸ“Š Upload to SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=wecelebrate
            -Dsonar.organization=your-org
            -Dsonar.javascript.lcov.reportPaths=lcov.info
            -Dsonar.coverage.exclusions=**/*.test.ts,**/*.test.tsx
