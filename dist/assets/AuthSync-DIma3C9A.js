import{r as n,j as s,T as b,C as g,a7 as i,X as m,K as N,w as y,p as f}from"./index-DAep3-17.js";import{C as v,a as w,b as S,c as A,d as C}from"./card-D7HVS59i.js";import{A as c,b as l}from"./alert-CNc3tQv-.js";import{U as k}from"./users-BInxthQ2.js";import{K as T}from"./key-BSEOBSLQ.js";function R(){const[x,h]=n.useState(!1),[u,j]=n.useState(!1),[t,d]=n.useState(null),[a,o]=n.useState(null),p=async()=>{j(!0),d(null);try{const r=await(await fetch(`https://${y}.supabase.co/functions/v1/make-server-6fcaeea3/public/check-auth-status`,{headers:{Authorization:`Bearer ${f}`}})).json();d(r)}catch(e){console.error("Failed to check auth status:",e),d({success:!1,error:e instanceof Error?e.message:"Unknown error"})}finally{j(!1)}},U=async()=>{if(confirm("This will create Supabase Auth accounts for any admin users that are missing them. Continue?")){h(!0),o(null);try{const r=await(await fetch(`https://${y}.supabase.co/functions/v1/make-server-6fcaeea3/debug/sync-admin-auth`,{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"}})).json();o(r),r.success&&setTimeout(()=>p(),1e3)}catch(e){console.error("Failed to sync admin auth:",e),o({success:!1,error:e instanceof Error?e.message:"Unknown error"})}finally{h(!1)}}};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Admin Authentication Sync"}),s.jsx("p",{className:"text-gray-600 mt-1",children:"Diagnose and fix authentication issues by syncing KV store admin users with Supabase Auth"})]}),s.jsxs(c,{className:"border-amber-200 bg-amber-50",children:[s.jsx(b,{className:"w-4 h-4 text-amber-600"}),s.jsxs(l,{className:"text-amber-800",children:[s.jsx("strong",{children:`Use this tool if you're getting "Invalid login credentials" errors.`}),s.jsx("br",{}),"This occurs when admin users exist in the database but not in Supabase Auth."]})]}),s.jsxs(v,{children:[s.jsxs(w,{children:[s.jsxs(S,{className:"flex items-center gap-2",children:[s.jsx(k,{className:"w-5 h-5 text-[#D91C81]"}),"Check Authentication Status"]}),s.jsx(A,{children:"View current state of admin users in KV store and Supabase Auth"})]}),s.jsxs(C,{className:"space-y-4",children:[s.jsx(g,{onClick:p,disabled:u,className:"bg-[#00B4CC] hover:bg-[#0099B3] text-white",children:u?s.jsxs(s.Fragment,{children:[s.jsx(i,{className:"w-4 h-4 mr-2 animate-spin"}),"Checking..."]}):s.jsxs(s.Fragment,{children:[s.jsx(k,{className:"w-4 h-4 mr-2"}),"Check Status"]})}),t&&s.jsx("div",{className:"space-y-3",children:t.success?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"Supabase Auth"}),s.jsxs("p",{className:"text-blue-700",children:["Total Users: ",t.supabaseAuth.totalUsers]}),t.supabaseAuth.allUsers.length>0&&s.jsx("div",{className:"mt-2 space-y-1",children:t.supabaseAuth.allUsers.map(e=>s.jsxs("div",{className:"text-sm text-blue-600",children:["• ",e.email]},e.id))})]}),s.jsxs("div",{className:"p-4 bg-purple-50 border border-purple-200 rounded-lg",children:[s.jsx("h3",{className:"font-semibold text-purple-900 mb-2",children:"KV Store"}),s.jsxs("p",{className:"text-purple-700",children:["Total Admins: ",t.kvStore.totalAdmins]}),t.kvStore.admins.length>0&&s.jsx("div",{className:"mt-2 space-y-1",children:t.kvStore.admins.map(e=>s.jsxs("div",{className:"text-sm text-purple-600",children:["• ",e.username," (",e.email,") - ",e.role]},e.id))})]}),t.supabaseAuth.totalUsers!==t.kvStore.totalAdmins&&s.jsxs(c,{className:"border-red-200 bg-red-50",children:[s.jsx(b,{className:"w-4 h-4 text-red-600"}),s.jsxs(l,{className:"text-red-800",children:[s.jsx("strong",{children:"Mismatch detected!"})," KV store has ",t.kvStore.totalAdmins," admins but Supabase Auth has ",t.supabaseAuth.totalUsers," users. Use the sync tool below to fix this."]})]})]}):s.jsxs(c,{className:"border-red-200 bg-red-50",children:[s.jsx(m,{className:"w-4 h-4 text-red-600"}),s.jsxs(l,{className:"text-red-800",children:["Error: ",t.error]})]})})]})]}),s.jsxs(v,{children:[s.jsxs(w,{children:[s.jsxs(S,{className:"flex items-center gap-2",children:[s.jsx(i,{className:"w-5 h-5 text-[#D91C81]"}),"Sync Admin Users to Supabase Auth"]}),s.jsx(A,{children:"Create Supabase Auth accounts for any admin users that are missing them"})]}),s.jsxs(C,{className:"space-y-4",children:[s.jsx(g,{onClick:U,disabled:x,className:"bg-[#D91C81] hover:bg-[#B01669] text-white",children:x?s.jsxs(s.Fragment,{children:[s.jsx(i,{className:"w-4 h-4 mr-2 animate-spin"}),"Syncing..."]}):s.jsxs(s.Fragment,{children:[s.jsx(i,{className:"w-4 h-4 mr-2"}),"Sync Now"]})}),a&&s.jsx("div",{className:"space-y-3",children:a.success?s.jsxs(s.Fragment,{children:[s.jsxs(c,{className:"border-green-200 bg-green-50",children:[s.jsx(N,{className:"w-4 h-4 text-green-600"}),s.jsxs(l,{className:"text-green-800",children:[s.jsx("strong",{children:"Success!"})," ",a.message]})]}),s.jsxs("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg",children:[s.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Sync Results"}),s.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-blue-600",children:a.results.checked}),s.jsx("div",{className:"text-xs text-gray-600",children:"Checked"})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-green-600",children:a.results.synced}),s.jsx("div",{className:"text-xs text-gray-600",children:"Synced"})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-gray-600",children:a.results.skipped}),s.jsx("div",{className:"text-xs text-gray-600",children:"Skipped"})]})]}),a.results.details.map((e,r)=>s.jsxs("div",{className:"mb-2 p-3 bg-white border border-gray-200 rounded",children:[s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:e.email}),s.jsx("div",{className:"text-sm text-gray-600",children:e.username})]}),s.jsxs("div",{className:`flex items-center gap-1 text-sm font-medium ${e.status==="synced"?"text-green-600":e.status==="error"?"text-red-600":"text-gray-600"}`,children:[e.status==="synced"&&s.jsx(N,{className:"w-4 h-4"}),e.status==="error"&&s.jsx(m,{className:"w-4 h-4"}),e.status]})]}),e.tempPassword&&s.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded flex items-start gap-2",children:[s.jsx(T,{className:"w-4 h-4 text-yellow-600 mt-0.5"}),s.jsxs("div",{className:"flex-1 text-sm",children:[s.jsx("div",{className:"font-semibold text-yellow-800",children:"Temporary Password:"}),s.jsx("code",{className:"text-yellow-900 bg-yellow-100 px-2 py-1 rounded",children:e.tempPassword}),s.jsx("div",{className:"text-xs text-yellow-700 mt-1",children:"Use this password to log in. You'll be prompted to change it."})]})]}),e.error&&s.jsx("div",{className:"mt-1 text-sm text-red-600",children:e.error}),e.reason&&e.status!=="synced"&&s.jsx("div",{className:"mt-1 text-sm text-gray-600",children:e.reason})]},r))]})]}):s.jsxs(c,{className:"border-red-200 bg-red-50",children:[s.jsx(m,{className:"w-4 h-4 text-red-600"}),s.jsxs(l,{className:"text-red-800",children:["Error: ",a.error]})]})})]})]})]})}export{R as default};
