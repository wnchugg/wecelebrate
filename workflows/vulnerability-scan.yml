name: Vulnerability Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: OWASP Dependency Check
  owasp-scan:
    name: ğŸ›¡ï¸ OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ›¡ï¸ Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'wecelebrate'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            
      - name: ğŸ“Š Upload OWASP results
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports/
          retention-days: 30
          
  # Job 2: Trivy Vulnerability Scanner
  trivy-scan:
    name: ğŸ” Trivy Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          
      - name: ğŸ“Š Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          
  # Job 3: NPM Audit
  npm-audit:
    name: ğŸ“¦ NPM Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ” Run npm audit
        run: |
          npm audit --json > npm-audit.json || true
          
      - name: ğŸ“Š Parse npm audit results
        run: |
          echo "## ğŸ“¦ NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f npm-audit.json ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit.json)
            
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            
            if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Action required:** Critical or High vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi
          
      - name: ğŸ’¾ Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: npm-audit.json
          retention-days: 30
          
  # Job 4: Snyk Advanced Scanning
  snyk-scan:
    name: ğŸ Snyk Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json
          
      - name: ğŸ“Š Parse Snyk results
        if: always()
        run: |
          if [ -f snyk-report.json ]; then
            echo "## ğŸ Snyk Security Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Snyk scan completed. Check artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ğŸ’¾ Upload Snyk results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-report
          path: snyk-report.json
          retention-days: 30
          
  # Job 5: Container Scanning (if using Docker)
  container-scan:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: false  # Enable if using containers
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Build container image
        run: docker build -t wecelebrate:${{ github.sha }} .
        
      - name: ğŸ” Scan container with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wecelebrate:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-container-results.sarif'
          
      - name: ğŸ“Š Upload container scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-container-results.sarif'
          
  # Job 6: License Compliance Check
  license-check:
    name: âš–ï¸ License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ“¦ Install license checker
        run: npm install -g license-checker
        
      - name: âš–ï¸ Check licenses
        run: |
          license-checker --json --out licenses.json
          
      - name: ğŸ“Š Parse license results
        run: |
          echo "## âš–ï¸ License Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL=$(cat licenses.json | jq 'length')
          echo "Total dependencies: **$TOTAL**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for problematic licenses
          PROBLEMATIC=$(cat licenses.json | jq -r 'to_entries[] | select(.value.licenses | type == "string" and (contains("GPL") or contains("AGPL") or contains("LGPL"))) | .key' | wc -l)
          
          if [ $PROBLEMATIC -gt 0 ]; then
            echo "âš ï¸ **Warning:** Found $PROBLEMATIC packages with copyleft licenses" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No problematic licenses detected" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ğŸ’¾ Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30
          
  # Job 7: Security Headers Check
  security-headers:
    name: ğŸ”’ Security Headers Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: ğŸ”’ Check security headers
        run: |
          URL="https://staging.wecelebrate.app"
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            URL="https://wecelebrate.app"
          fi
          
          echo "## ğŸ”’ Security Headers Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking: $URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          HEADERS=$(curl -I -s $URL)
          
          echo "| Header | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check important security headers
          if echo "$HEADERS" | grep -qi "strict-transport-security"; then
            echo "| HSTS | âœ… Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| HSTS | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if echo "$HEADERS" | grep -qi "x-frame-options"; then
            echo "| X-Frame-Options | âœ… Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| X-Frame-Options | âš ï¸ Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if echo "$HEADERS" | grep -qi "x-content-type-options"; then
            echo "| X-Content-Type-Options | âœ… Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| X-Content-Type-Options | âš ï¸ Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if echo "$HEADERS" | grep -qi "content-security-policy"; then
            echo "| CSP | âœ… Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CSP | âš ï¸ Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
  # Job 8: Vulnerability Summary
  vulnerability-summary:
    name: ğŸ“‹ Vulnerability Summary
    runs-on: ubuntu-latest
    needs: [owasp-scan, trivy-scan, npm-audit, snyk-scan, license-check]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate vulnerability summary
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJson(needs) }};
            
            let summary = `## ğŸ›¡ï¸ Vulnerability Scan Summary\n\n`;
            summary += `**Scan Date:** ${new Date().toISOString()}\n\n`;
            summary += `| Scanner | Status |\n`;
            summary += `|---------|--------|\n`;
            summary += `| OWASP Dependency Check | ${needs['owasp-scan'].result === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            summary += `| Trivy | ${needs['trivy-scan'].result === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            summary += `| NPM Audit | ${needs['npm-audit'].result === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            summary += `| Snyk | ${needs['snyk-scan'].result === 'success' ? 'âœ…' : 'âŒ'} |\n`;
            summary += `| License Check | ${needs['license-check'].result === 'success' ? 'âœ…' : 'âŒ'} |\n\n`;
            
            const allPassed = Object.values(needs).every(job => job.result === 'success');
            
            if (allPassed) {
              summary += `âœ… **All vulnerability scans passed!**\n`;
            } else {
              summary += `âš ï¸ **Some scans detected issues. Review artifacts for details.**\n`;
            }
            
            await core.summary.addRaw(summary).write();
            
            // Create issue if critical vulnerabilities found
            if (!allPassed && context.eventName !== 'pull_request') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ Security Vulnerabilities Detected',
                body: summary + '\n\nPlease review the workflow run for details.',
                labels: ['security', 'vulnerability']
              });
            }
