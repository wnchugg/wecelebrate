import{r as q,j as e,C as Z,g as ee,w as M,ac as se,a3 as _,p as Q}from"./index-BKvtyMRF.js";function ae(){var h,g,p,m,x,b,j,y,f,N,v,k,C,S,w,T,E,D,F,O,A,I,R,J,L,U,$,z,B,G,K,P,H;const[d,u]=q.useState(!1),[s,V]=q.useState(null),Y=async()=>{var W,X;u(!0);const a={timestamp:new Date().toISOString(),environment:null,token:null,apiCalls:{},errors:[]};try{const i=ee();a.environment={id:i.id,name:i.name,supabaseUrl:i.supabaseUrl,apiUrl:`https://${M}.supabase.co/functions/v1/make-server-6fcaeea3`};const l=se();if(l)try{const t=l.split("."),r=JSON.parse(atob(t[0])),n=JSON.parse(atob(t[1]));a.token={exists:!0,algorithm:r.alg,userId:n.userId,email:n.email,role:n.role,environmentId:n.environmentId,issuedAt:new Date(n.iat*1e3).toISOString(),expiresAt:new Date(n.exp*1e3).toISOString(),isExpired:n.exp<Math.floor(Date.now()/1e3)}}catch(t){a.token={exists:!0,error:t.message}}else a.token={exists:!1};console.log("ðŸ” Testing /sites endpoint...");try{const t=await _("/sites");a.apiCalls.sites={success:!0,responseFormat:t,dataLength:((W=t.data)==null?void 0:W.length)||0,hasSuccessFlag:"success"in t,hasDataProperty:"data"in t}}catch(t){a.apiCalls.sites={success:!1,error:t.message,status:t.status||t.statusCode},a.errors.push({endpoint:"/sites",error:t.message})}console.log("ðŸ” Testing /clients endpoint...");try{const t=await _("/clients");a.apiCalls.clients={success:!0,responseFormat:t,dataLength:((X=t.data)==null?void 0:X.length)||0,hasSuccessFlag:"success"in t,hasDataProperty:"data"in t}}catch(t){a.apiCalls.clients={success:!1,error:t.message,status:t.status||t.statusCode},a.errors.push({endpoint:"/clients",error:t.message})}console.log("ðŸ” Testing direct fetch to /sites...");try{const t=`https://${M}.supabase.co/functions/v1/make-server-6fcaeea3/sites`,r={"Content-Type":"application/json","X-Environment-ID":i.id};l?(r["X-Access-Token"]=l,r.Authorization=`Bearer ${i.supabaseAnonKey||Q}`):r.Authorization=`Bearer ${i.supabaseAnonKey||Q}`;const n=await fetch(t,{headers:r,credentials:"omit"}),o=await n.text();let c;try{c=JSON.parse(o)}catch{c=o}a.apiCalls.directFetch={url:t,status:n.status,statusText:n.statusText,headers:Object.fromEntries(n.headers.entries()),responseText:o.substring(0,500),parsedResponse:c}}catch(t){a.apiCalls.directFetch={error:t.message}}}catch(i){a.errors.push({general:i.message})}V(a),u(!1),console.log("=".repeat(80)),console.log("SITES DIAGNOSTIC RESULTS"),console.log("=".repeat(80)),console.log(JSON.stringify(a,null,2)),console.log("=".repeat(80))};return e.jsxs("div",{className:"p-8 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Sites Loading Diagnostic"}),e.jsx("p",{className:"text-gray-600",children:"This page helps diagnose why sites aren't loading in the admin panel."})]}),e.jsx(Z,{onClick:Y,disabled:d,className:"mb-6",children:d?"Running Diagnostics...":"Run Diagnostics"}),s&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Environment"}),e.jsx("pre",{className:"bg-gray-50 p-4 rounded overflow-x-auto text-sm",children:JSON.stringify(s.environment,null,2)})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Authentication Token"}),e.jsx("pre",{className:"bg-gray-50 p-4 rounded overflow-x-auto text-sm",children:JSON.stringify(s.token,null,2)})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"API Call Results"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"GET /sites"}),e.jsx("pre",{className:"bg-gray-50 p-4 rounded overflow-x-auto text-sm",children:JSON.stringify(s.apiCalls.sites,null,2)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"GET /clients"}),e.jsx("pre",{className:"bg-gray-50 p-4 rounded overflow-x-auto text-sm",children:JSON.stringify(s.apiCalls.clients,null,2)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Direct Fetch (Raw Response)"}),e.jsx("pre",{className:"bg-gray-50 p-4 rounded overflow-x-auto text-sm",children:JSON.stringify(s.apiCalls.directFetch,null,2)})]})]})]}),s.errors.length>0&&e.jsxs("div",{className:"bg-red-50 p-6 rounded-lg border border-red-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-red-900",children:"Errors"}),e.jsx("pre",{className:"bg-white p-4 rounded overflow-x-auto text-sm text-red-800",children:JSON.stringify(s.errors,null,2)})]}),e.jsxs("div",{className:"bg-blue-50 p-6 rounded-lg border border-blue-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-blue-900",children:"Summary"}),e.jsxs("ul",{className:"space-y-2 text-sm text-blue-800",children:[e.jsxs("li",{children:["âœ“ Environment ID: ",(h=s.environment)==null?void 0:h.id]}),e.jsxs("li",{children:[(g=s.token)!=null&&g.exists?"âœ“":"âœ—"," Token exists"]}),((p=s.token)==null?void 0:p.exists)&&e.jsxs(e.Fragment,{children:[e.jsxs("li",{children:[((m=s.token)==null?void 0:m.algorithm)==="HS256"?"âœ“":"âœ—"," Token algorithm: ",(x=s.token)==null?void 0:x.algorithm]}),e.jsxs("li",{children:[(b=s.token)!=null&&b.isExpired?"âœ—":"âœ“"," Token ",(j=s.token)!=null&&j.isExpired?"expired":"valid"]})]}),e.jsxs("li",{children:[(f=(y=s.apiCalls)==null?void 0:y.sites)!=null&&f.success?"âœ“":"âœ—"," Sites endpoint response"]}),e.jsxs("li",{children:[(v=(N=s.apiCalls)==null?void 0:N.clients)!=null&&v.success?"âœ“":"âœ—"," Clients endpoint response"]}),((C=(k=s.apiCalls)==null?void 0:k.sites)==null?void 0:C.success)&&e.jsxs("li",{children:["ðŸ“Š Sites returned: ",((w=(S=s.apiCalls)==null?void 0:S.sites)==null?void 0:w.dataLength)||0]}),((E=(T=s.apiCalls)==null?void 0:T.clients)==null?void 0:E.success)&&e.jsxs("li",{children:["ðŸ“Š Clients returned: ",((F=(D=s.apiCalls)==null?void 0:D.clients)==null?void 0:F.dataLength)||0]})]})]}),e.jsxs("div",{className:"bg-yellow-50 p-6 rounded-lg border border-yellow-200",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-yellow-900",children:"Suggested Actions"}),e.jsxs("ul",{className:"space-y-2 text-sm text-yellow-800 list-disc list-inside",children:[!((O=s.token)!=null&&O.exists)&&e.jsx("li",{children:"No authentication token found - try logging out and logging in again"}),((A=s.token)==null?void 0:A.exists)&&((I=s.token)==null?void 0:I.algorithm)!=="HS256"&&e.jsx("li",{children:"Wrong token algorithm - backend may not be deployed. Check Supabase Functions."}),((R=s.token)==null?void 0:R.isExpired)&&e.jsx("li",{children:"Token is expired - log out and log in again"}),((L=(J=s.apiCalls)==null?void 0:J.sites)==null?void 0:L.success)&&(($=(U=s.apiCalls)==null?void 0:U.sites)==null?void 0:$.dataLength)===0&&e.jsx("li",{children:"No sites found in database - you may need to seed data or create sites"}),((B=(z=s.apiCalls)==null?void 0:z.directFetch)==null?void 0:B.status)===403&&e.jsx("li",{children:"403 Forbidden - middleware is blocking access. Check verifyAdmin middleware."}),((K=(G=s.apiCalls)==null?void 0:G.directFetch)==null?void 0:K.status)===401&&e.jsx("li",{children:"401 Unauthorized - token validation failing. Check JWT_SECRET configuration."}),((H=(P=s.apiCalls)==null?void 0:P.directFetch)==null?void 0:H.status)===404&&e.jsx("li",{children:"404 Not Found - backend routes may not be deployed correctly"})]})]})]})]})}export{ae as SitesDiagnostic};
