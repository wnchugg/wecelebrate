import{r as i,g as v,j as e,a4 as I,D as K,l as d,a3 as V}from"./index-o4gpx1In.js";import{s as c,a as N,b as k}from"./errorHandling-CFBDpS8c.js";import{W as C}from"./wrench-CmLSeQHU.js";import{C as l}from"./circle-alert-Bm1NT70L.js";import{U as A}from"./users-BcVQ6wgG.js";import{C as f}from"./circle-check-big-b_APp8Jk.js";function F(){var g;const[o,m]=i.useState(!1),[x,h]=i.useState(!1),[r,p]=i.useState(null),[t,R]=i.useState(null),u=v(),y=`https://${(g=u.supabaseUrl.match(/https:\/\/([^.]+)/))==null?void 0:g[1]}.supabase.co/functions/v1/make-server-6fcaeea3`,b=async()=>{var s,j;m(!0),p(null);try{const n=await fetch(`${y}/debug/check-admin-users`,{headers:{"X-Environment-ID":u.id}}),a=await n.json();if(!n.ok)throw new Error(a.message||"Failed to check admin users");p(a),d.log("[Diagnostic] Check results:",a),((s=a.syncIssues)==null?void 0:s.orphanedKV)>0||((j=a.syncIssues)==null?void 0:j.missingKV)>0?c(new Error(`Found ${a.syncIssues.orphanedKV+a.syncIssues.missingKV} sync issues`),{operation:"diagnostic"}):N("All users are properly synced!")}catch(n){d.error("[Diagnostic] Check error:",n),c(n,{operation:"diagnostic-check"})}finally{m(!1)}},w=async()=>{if(window.confirm("This will attempt to repair admin user data. Continue?")){h(!0);try{const s=await V("/admin/repair-users",{method:"POST",body:JSON.stringify({})});s.repaired>0?N("Users Repaired",`Successfully repaired ${s.repaired} admin user records`):k("No Repairs Needed","All admin users are already in sync"),setTimeout(()=>{b()},1e3)}catch(s){d.error("[Diagnostic] Repair error:",s),c(s,{operation:"diagnostic-repair"})}finally{h(!1)}}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-[#1B2A5E] via-[#D91C81] to-[#00B4CC] flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-4xl",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl overflow-hidden mb-4",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-500 to-red-500 p-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-4",children:e.jsx(C,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-2xl font-bold text-white mb-2",children:"üîß Admin User Diagnostic Tools"}),e.jsx("p",{className:"text-white/90 text-sm",children:"Check and repair admin user sync issues"})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(l,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-blue-900 text-sm mb-1",children:"What This Tool Does"}),e.jsx("p",{className:"text-xs text-blue-800",children:"This diagnostic tool checks if your admin users are properly synced between the KV store (metadata) and Supabase Auth (password verification). If they're out of sync, you won't be able to login."})]})]})}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsx("button",{onClick:b,disabled:o,className:"bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-6 rounded-xl font-bold text-lg hover:shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Checking..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-5 h-5"}),"Check Admin Users"]})}),e.jsx("button",{onClick:w,disabled:x||!r,className:"bg-gradient-to-r from-green-600 to-green-700 text-white py-4 px-6 rounded-xl font-bold text-lg hover:shadow-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Repairing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-5 h-5"}),"Repair Sync Issues"]})})]}),r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5"}),"Diagnostic Results"]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-blue-600 font-semibold mb-1",children:"KV Store Users"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:r.kvAdminCount})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-purple-600 font-semibold mb-1",children:"Supabase Auth Users"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:r.authUserCount})]}),e.jsxs("div",{className:`${r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?"bg-red-50 border-red-200":"bg-green-50 border-green-200"} border rounded-lg p-4`,children:[e.jsx("p",{className:`text-sm font-semibold mb-1 ${r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?"text-red-600":"text-green-600"}`,children:"Sync Issues"}),e.jsx("p",{className:`text-2xl font-bold ${r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?"text-red-900":"text-green-900"}`,children:r.syncIssues.orphanedKV+r.syncIssues.missingKV})]})]}),e.jsx("div",{className:`${r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?"bg-red-50 border-red-200":"bg-green-50 border-green-200"} border rounded-xl p-4`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?e.jsx(l,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}):e.jsx(f,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:`font-semibold text-sm mb-1 ${r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?"text-red-900":"text-green-900"}`,children:"Recommendation"}),e.jsx("p",{className:`text-xs ${r.syncIssues.orphanedKV+r.syncIssues.missingKV>0?"text-red-800":"text-green-800"}`,children:r.recommendation})]})]})}),r.syncIssues.orphanedKV>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-red-900 mb-2 flex items-center gap-2",children:[e.jsx(l,{className:"w-4 h-4"}),"‚ùå Orphaned Users (Cannot Login - ",r.syncIssues.orphanedKV,")"]}),e.jsx("p",{className:"text-xs text-red-700 mb-3",children:"These users exist in the KV store but NOT in Supabase Auth. They cannot login because password verification fails."}),e.jsx("div",{className:"space-y-2",children:r.syncIssues.orphanedKVUsers.map(s=>e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-red-300",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:s.email}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Username: ",s.username]}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:s.issue})]},s.id))})]}),r.syncIssues.missingKV>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-yellow-900 mb-2 flex items-center gap-2",children:[e.jsx(l,{className:"w-4 h-4"}),"‚ö†Ô∏è Missing Metadata (",r.syncIssues.missingKV,")"]}),e.jsx("p",{className:"text-xs text-yellow-700 mb-3",children:"These users exist in Supabase Auth but are missing metadata in the KV store."}),e.jsx("div",{className:"space-y-2",children:r.syncIssues.missingKVUsers.map(s=>e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-yellow-300",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:s.email}),e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:s.issue})]},s.id))})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-xl p-4",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-900 mb-3",children:"All Admin Users"}),e.jsx("div",{className:"space-y-2",children:r.kvAdmins.map(s=>e.jsx("div",{className:"bg-white rounded-lg p-3 border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:s.email}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Username: ",s.username," | Role: ",s.role]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"In Supabase Auth:"}),e.jsx("span",{className:"text-lg",children:s.inSupabaseAuth})]})]})},s.id))})]})]}),t&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(f,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-green-900 text-sm mb-1",children:"Repair Complete"}),e.jsx("p",{className:"text-xs text-green-800 mb-3",children:t.summary}),t.removed>0&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("p",{className:"text-xs font-semibold text-green-900 mb-1",children:["Removed (",t.removed,"):"]}),e.jsx("ul",{className:"list-disc list-inside text-xs text-green-800",children:t.removedUsers.map(s=>e.jsxs("li",{children:[s.email," - ",s.reason]},s.id))})]}),t.repaired>0&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs font-semibold text-green-900 mb-1",children:["Added (",t.repaired,"):"]}),e.jsx("ul",{className:"list-disc list-inside text-xs text-green-800",children:t.repairedUsers.map(s=>e.jsxs("li",{children:[s.email," - ",s.reason]},s.id))})]})]})]})})]})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("p",{className:"text-white/90 text-sm",children:e.jsx("a",{href:"/admin/login",className:"text-white font-semibold hover:underline",children:"‚Üê Back to Login"})}),e.jsx("p",{className:"text-white/70 text-xs",children:e.jsx("a",{href:"/admin/bootstrap",className:"text-white/90 hover:underline",children:"Create New Admin Account"})})]})]})})}export{F as DiagnosticTools,F as default};
